From 4e99d050c8d001efd90b8256278b45f045cd210a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Marczykowski-G=C3=B3recki?=
 <marmarek@invisiblethingslab.com>
Date: Wed, 20 Apr 2016 03:06:02 +0200
Subject: [PATCH] Hacky way to pass gpgkey to lorax
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Since lorax is running in separate process, it no longer use repo
objects initialized by pungi. Because of this, gpgkey+gpgcheck must be
passed down some other way. Appending it to the repository URL is awful,
but is effective:
 - if lorax version used doesn't support verification, it will fail
 (good)
 - it binds key to the repository

Signed-off-by: Marek Marczykowski-GÃ³recki <marmarek@invisiblethingslab.com>
---
 pungi/gather.py | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/pungi/gather.py b/pungi/gather.py
index 423474e..3ffc122 100644
--- a/pungi/gather.py
+++ b/pungi/gather.py
@@ -1553,15 +1553,16 @@ class Pungi(PungiBase):
             pass
 
         for repo in self.ksparser.handler.repo.repoList:
+            url_suffix = '({})'.format(repo.gpgkey) if repo.gpgkey else ''
             if repo.mirrorlist:
                 # The not bool() thing is because pykickstart is yes/no on
                 # whether to ignore groups, but yum is a yes/no on whether to
                 # include groups.  Awkward.
                 repo.mirrorlist = yum.parser.varReplace(repo.mirrorlist, self.ayum.conf.yumvar)
-                cmd.extend(["--mirrorlist", repo.mirrorlist])
+                cmd.extend(["--mirrorlist", repo.mirrorlist + url_suffix])
             else:
                 repo.baseurl = yum.parser.varReplace(repo.baseurl, self.ayum.conf.yumvar)
-                cmd.extend(["--source", repo.baseurl])
+                cmd.extend(["--source", repo.baseurl + url_suffix])
 
         # Add the repo in the destdir to our yum object
         cmd.extend(["--source", "file://%s" % self.topdir])
-- 
2.17.2

